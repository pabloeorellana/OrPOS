version: '3.8'

services:
  # Servicio del Frontend. Lo llamaremos 'web' para simplificar.
  web:
    build:
      # El 'contexto' es el directorio actual (la raíz del repo), 
      # donde está este archivo y el Dockerfile.
      context: . 
      # Apunta al Dockerfile en el directorio actual.
      dockerfile: Dockerfile
      args:
        # Pasa la variable VITE_API_URL desde los secretos de Coolify al build.
        VITE_API_URL: ${VITE_API_URL}
    restart: always
    networks:
      - coolify
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=coolify"
      
      # SERVICE
      - "traefik.http.services.orpos-web-svc.loadbalancer.server.port=80"
      
      # MIDDLEWARE de Redirección
      - "traefik.http.middlewares.orpos-https-redirect.redirectscheme.scheme=https"
      
      # ROUTER HTTP (para redirigir)
      - "traefik.http.routers.orpos-web-http.rule=Host(`orpos.site`) || Host(`www.orpos.site`) || HostRegexp(`{subdomain:[a-z0-9-]+}.orpos.site`)"
      - "traefik.http.routers.orpos-web-http.entrypoints=http"
      - "traefik.http.routers.orpos-web-http.middlewares=orpos-https-redirect"
      
      # ROUTER HTTPS (principal)
      - "traefik.http.routers.orpos-web-secure.rule=Host(`orpos.site`) || Host(`www.orpos.site`) || HostRegexp(`{subdomain:[a-z0-9-]+}.orpos.site`)"
      - "traefik.http.routers.orpos-web-secure.entrypoints=https"
      - "traefik.http.routers.orpos-web-secure.tls=true"
      - "traefik.http.routers.orpos-web-secure.tls.certresolver=letsencrypt-dns"
      - "traefik.http.routers.orpos-web-secure.tls.domains[0].main=orpos.site"
      - "traefik.http.routers.orpos-web-secure.tls.domains[0].sans=*.orpos.site"
      # Apunta el router al service
      - "traefik.http.routers.orpos-web-secure.service=orpos-web-svc"

networks:
  coolify:
    external: true